name: Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"

env:
  SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

jobs:
  build_ios:
    name: Build iOS IPA
    runs-on: macos-15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: Get version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag: $TAG_NAME, Version: $VERSION"

      - name: Get commit hash
        id: get_commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "Commit Hash: $COMMIT_HASH"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.14.0
        with:
          flutter-version: "3.38.9"
          cache: true
          cache-key: "flutter-:os:-:channel:-:version:-:arch:-:hash:"
          cache-path: "${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:"

      - name: Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Update pubspec.yaml version
        run: |
          sed -i.bak "s/^version: .*/version: ${{ steps.get_version.outputs.version }}+${{ github.run_number }}/" pubspec.yaml
          echo "Updated pubspec.yaml version to ${{ steps.get_version.outputs.version }}+${{ github.run_number }}"
          cat pubspec.yaml | grep "^version:"

      - name: Install Flutter Dependencies
        run: flutter pub get

      - name: Install CocoaPods Dependencies
        run: |
          cd ios
          pod install
          cd ..

      - name: Create config.json
        run: |
          cat <<EOF > config.json
          {
            "BUILD_VERSION": "${{ steps.get_version.outputs.version }}",
            "BUILD_NUMBER": "${{ github.run_number }}",
            "COMMIT_HASH": "${{ steps.get_commit.outputs.hash }}",
            "MAIMAI_NET_API_AES_KEY": "${{ secrets.MAIMAI_NET_API_AES_KEY }}",
            "MAIMAI_NET_API_AES_IV": "${{ secrets.MAIMAI_NET_API_AES_IV }}",
            "MAIMAI_NET_API_OBFUSCATE_PARAM": "${{ secrets.MAIMAI_NET_API_OBFUSCATE_PARAM }}",
            "MAIMAI_NET_API_KEYCHIP_ID": "${{ secrets.MAIMAI_NET_API_KEYCHIP_ID }}",
            "MAIMAI_NET_API_SALT": "${{ secrets.MAIMAI_NET_API_SALT }}",
            "MAIMAI_NET_API_OPEN_GAME_ID": "${{ secrets.MAIMAI_NET_API_OPEN_GAME_ID }}",
            "MAIMAI_NET_API_CHIME_ENDPOINT": "${{ secrets.MAIMAI_NET_API_CHIME_ENDPOINT }}",
            "MAIMAI_NET_API_TITLE_ENDPOINT": "${{ secrets.MAIMAI_NET_API_TITLE_ENDPOINT }}",
            "MAIMAI_NET_API_OPEN_GAME_ID": "${{ secrets.MAIMAI_NET_API_OPEN_GAME_ID }}",
            "MAIMAI_NET_API_MAI_ENCODING": "${{ secrets.MAIMAI_NET_API_MAI_ENCODING }}"
          }
          EOF

      - name: Build iOS IPA
        run: |
          flutter build ipa \
            --release \
            --no-codesign \
            --build-number=${{ github.run_number }} \
            --dart-define-from-file=config.json

      - name: Package Unsigned IPA
        run: |
          mkdir -p Payload
          cp -r build/ios/archive/Runner.xcarchive/Products/Applications/Runner.app Payload/
          zip -r RankHub-${{ steps.get_version.outputs.version }}.ipa Payload
          rm -rf Payload

      - name: Upload iOS IPA
        uses: actions/upload-artifact@v4.3.3
        with:
          name: RankHub-iOS-${{ steps.get_version.outputs.version }}
          path: RankHub-${{ steps.get_version.outputs.version }}.ipa

  build_android:
    name: Build Android APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: Get version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag: $TAG_NAME, Version: $VERSION"

      - name: Get commit hash
        id: get_commit
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "Commit Hash: $COMMIT_HASH"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.14.0
        with:
          flutter-version: "3.38.9"
          cache: true
          cache-key: "flutter-:os:-:channel:-:version:-:arch:-:hash:"
          cache-path: "${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:"

      - name: Cache Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ${{ github.workspace }}/.dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Update pubspec.yaml version
        run: |
          sed -i "s/^version: .*/version: ${{ steps.get_version.outputs.version }}+${{ github.run_number }}/" pubspec.yaml
          echo "Updated pubspec.yaml version to ${{ steps.get_version.outputs.version }}+${{ github.run_number }}"
          cat pubspec.yaml | grep "^version:"

      - name: Install Flutter Dependencies
        run: flutter pub get

      - name: Decode Keystore
        run: echo "${{ secrets.ANDROID_RELEASE_KEY }}" | base64 --decode > android/app/release.keystore

      - name: Create key.properties
        run: |
          cat <<EOF > android/key.properties
          storePassword=${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}
          keyPassword=${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}
          keyAlias=upload
          storeFile=release.keystore
          EOF

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Create config.json
        run: |
          cat <<EOF > config.json
          {
            "BUILD_VERSION": "${{ steps.get_version.outputs.version }}",
            "BUILD_NUMBER": "${{ github.run_number }}",
            "COMMIT_HASH": "${{ steps.get_commit.outputs.hash }}",
            "MAIMAI_NET_API_AES_KEY": "${{ secrets.MAIMAI_NET_API_AES_KEY }}",
            "MAIMAI_NET_API_AES_IV": "${{ secrets.MAIMAI_NET_API_AES_IV }}",
            "MAIMAI_NET_API_OBFUSCATE_PARAM": "${{ secrets.MAIMAI_NET_API_OBFUSCATE_PARAM }}",
            "MAIMAI_NET_API_KEYCHIP_ID": "${{ secrets.MAIMAI_NET_API_KEYCHIP_ID }}",
            "MAIMAI_NET_API_SALT": "${{ secrets.MAIMAI_NET_API_SALT }}",
            "MAIMAI_NET_API_OPEN_GAME_ID": "${{ secrets.MAIMAI_NET_API_OPEN_GAME_ID }}",
            "MAIMAI_NET_API_CHIME_ENDPOINT": "${{ secrets.MAIMAI_NET_API_CHIME_ENDPOINT }}",
            "MAIMAI_NET_API_TITLE_ENDPOINT": "${{ secrets.MAIMAI_NET_API_TITLE_ENDPOINT }}",
            "MAIMAI_NET_API_OPEN_GAME_ID": "${{ secrets.MAIMAI_NET_API_OPEN_GAME_ID }}",
            "MAIMAI_NET_API_MAI_ENCODING": "${{ secrets.MAIMAI_NET_API_MAI_ENCODING }}"
          }
          EOF

      - name: Build Android APK (Split per ABI)
        run: |
          flutter build apk \
            --release \
            --split-per-abi \
            --build-number=${{ github.run_number }} \
            --dart-define-from-file=config.json

      - name: Rename APK files with version
        run: |
          cd build/app/outputs/flutter-apk
          for file in app-*.apk; do
            if [ -f "$file" ]; then
              newname=$(echo "$file" | sed "s/app-/RankHub-${{ steps.get_version.outputs.version }}-/")
              mv "$file" "$newname"
              echo "Renamed $file to $newname"
            fi
          done
          ls -lh

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4.3.3
        with:
          name: RankHub-Android-${{ steps.get_version.outputs.version }}
          path: build/app/outputs/flutter-apk/RankHub-*.apk

  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build_ios, build_android]
    permissions:
      contents: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4.2.2

      - name: Get version from tag
        id: get_version
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_NAME#v}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag: $TAG_NAME, Version: $VERSION"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: List downloaded artifacts
        run: |
          echo "Downloaded artifacts:"
          ls -R ./artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release_assets

          # Find and copy iOS IPA
          find ./artifacts -name "*.ipa" -exec cp {} release_assets/ \;

          # Find and copy Android APKs
          find ./artifacts -name "*.apk" -exec cp {} release_assets/ \;

          echo "Release assets prepared:"
          ls -lh release_assets/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.get_version.outputs.tag }}
          name: Release ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          files: |
            release_assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
